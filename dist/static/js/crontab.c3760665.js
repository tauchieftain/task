(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["crontab"],{"2f1a":function(t,e,a){"use strict";a.r(e);var s=function(){var t=this,e=t._self._c;return e("div",{staticClass:"page-wrapper common-page"},[e("div",{staticClass:"nav-header"},[e("div",{staticClass:"top-link-item active"},[e("el-link",[t._v("定时任务")])],1),e("div",{staticClass:"top-link-item"},[e("el-link",{on:{click:function(e){return t.goto("/node/daemon",t.$route.query)}}},[t._v("常驻任务")])],1)]),e("div",{staticClass:"top-tools"},[e("el-form",{staticClass:"kw-el-form-class",attrs:{inline:!0,size:"small"},on:{submit:function(t){t.preventDefault()}}},[e("el-form-item",{attrs:{label:"任务名称"}},[e("el-input",{attrs:{placeholder:"请输入任务名称"},model:{value:t.searchForm.keyword,callback:function(e){t.$set(t.searchForm,"keyword",e)},expression:"searchForm.keyword"}})],1),e("el-form-item",[e("el-button",{attrs:{type:"primary",icon:"el-icon-search"},on:{click:t.handleSearch}},[t._v("查询")]),e("el-button",{attrs:{type:"text"},on:{click:t.handleReset}},[t._v("清空")])],1)],1)],1),e("div",{staticClass:"table-tools"},[e("div",[e("el-button",{attrs:{type:"primary"},on:{click:t.toConfig}},[t._v("配置")]),e("el-button",{attrs:{type:"primary"},on:{click:t.toLog}},[t._v("日志")])],1),e("div",[e("el-button",{attrs:{type:"primary"},on:{click:t.addCrontab}},[t._v("添加")])],1)]),e("div",{staticClass:"page-table-container"},[e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.tableLoading,expression:"tableLoading"}],staticClass:"kw-table-data",attrs:{data:t.tableData,border:"",size:"small","row-key":"id"}},[e("el-table-column",{attrs:{prop:"id",label:"任务ID",width:"80px"}}),e("el-table-column",{attrs:{prop:"name",label:"任务名称"}}),e("el-table-column",{attrs:{prop:"dir",label:"执行目录"}}),e("el-table-column",{attrs:{prop:"command",label:"执行命令"}}),e("el-table-column",{attrs:{prop:"time_expr",label:"Cron表达式"}}),e("el-table-column",{attrs:{prop:"status",label:"任务状态",width:"120px"},scopedSlots:t._u([{key:"default",fn:function({row:a}){return[e("p",[t._v(t._s("Unaudited"==a.status?"未审核":"Ok"==a.status?"已审核":"Timing"==a.status?"已开启":"Running"==a.status?"执行中":"Stopped"==a.status?"已停止":""))])]}}])}),e("el-table-column",{attrs:{prop:"last_exec_status",label:"上次执行状态",width:"120px"},scopedSlots:t._u([{key:"default",fn:function({row:a}){return[e("p",[t._v(t._s("Error"==a.last_exec_status?"执行失败":"Success"==a.last_exec_status?"执行成功":"Timeout"==a.last_exec_status?"执行超时":""))]),"Success"!=a.last_exec_status?e("p",[t._v(t._s(a.last_exec_msg))]):t._e()]}}])}),e("el-table-column",{attrs:{prop:"last_exec_time",label:"上次执行时间",width:"140px"},scopedSlots:t._u([{key:"default",fn:function({row:e}){return[t._v(" "+t._s(0==e.last_exec_time?"":t.getComputedDate(e.last_exec_time,!0))+" ")]}}])}),e("el-table-column",{attrs:{prop:"last_cost_time",label:"上次执行耗时",width:"120px"}}),e("el-table-column",{attrs:{prop:"next_exec_time",label:"下次执行时间",width:"140px"},scopedSlots:t._u([{key:"default",fn:function({row:e}){return[t._v(" "+t._s(0==e.next_exec_time?"":t.getComputedDate(e.next_exec_time,!0))+" ")]}}])}),e("el-table-column",{attrs:{prop:"create_user",label:"创建人",width:"120px"}}),e("el-table-column",{attrs:{prop:"create_time",label:"创建时间",width:"140px"},scopedSlots:t._u([{key:"default",fn:function({row:e}){return[t._v(" "+t._s(t.getComputedDate(e.create_time,!0))+" ")]}}])}),e("el-table-column",{attrs:{label:"操作",width:"260px"},scopedSlots:t._u([{key:"default",fn:function({row:a}){return[e("el-button",{directives:[{name:"getPermission",rawName:"v-getPermission",value:"log",expression:"'log'"}],attrs:{type:"text"},on:{click:function(e){return t.showCrontabLog(a)}}},[t._v("日志")]),"Unaudited"==a.status?e("el-button",{directives:[{name:"getPermission",rawName:"v-getPermission",value:"audit",expression:"'audit'"}],attrs:{type:"text"},on:{click:function(e){return t.handleChangeCommand("audit",a)}}},[t._v("审核")]):t._e(),e("el-button",{directives:[{name:"getPermission",rawName:"v-getPermission",value:"edit",expression:"'edit'"}],attrs:{type:"text"},on:{click:function(e){return t.handleChangeCommand("edit",a)}}},[t._v("编辑")]),"Unaudited"!=a.status&&"Timing"!=a.status&&"Running"!=a.status?e("el-button",{directives:[{name:"getPermission",rawName:"v-getPermission",value:"start",expression:"'start'"}],attrs:{type:"text"},on:{click:function(e){return t.handleChangeCommand("start",a)}}},[t._v("开启")]):t._e(),"Unaudited"!=a.status&&"Stopped"!=a.status&&"Ok"!=a.status?e("el-button",{directives:[{name:"getPermission",rawName:"v-getPermission",value:"stop",expression:"'stop'"}],attrs:{type:"text"},on:{click:function(e){return t.handleChangeCommand("stop",a)}}},[t._v("停止")]):t._e(),"Unaudited"!=a.status?e("el-button",{directives:[{name:"getPermission",rawName:"v-getPermission",value:"run",expression:"'run'"}],attrs:{type:"text"},on:{click:function(e){return t.handleChangeCommand("exec",a)}}},[t._v("执行")]):t._e(),e("el-button",{directives:[{name:"getPermission",rawName:"v-getPermission",value:"del",expression:"'del'"}],attrs:{type:"text"},on:{click:function(e){return t.handleChangeCommand("del",a)}}},[t._v("删除")]),"Running"==a.status?e("el-button",{directives:[{name:"getPermission",rawName:"v-getPermission",value:"kill",expression:"'kill'"}],attrs:{type:"text"},on:{click:function(e){return t.handleChangeCommand("kill",a)}}},[t._v("强杀")]):t._e()]}}])})],1),e("el-pagination",{attrs:{align:"center","current-page":t.currentPage,"page-sizes":[10,20,50,100],"page-size":t.pageSize,layout:"total, sizes, prev, pager, next, jumper",total:t.total},on:{"size-change":t.handleSizeChange,"current-change":t.handleCurrentChange}})],1),e("el-dialog",{attrs:{title:"任务操作",visible:t.dialogVisible,width:"400px"},on:{"update:visible":function(e){t.dialogVisible=e}}},[e("div",[e("el-form",{attrs:{"label-position":"left","label-width":"100px",size:"small"}},[e("el-form-item",{staticStyle:{"margin-bottom":"5px"},attrs:{label:"操作类型"}},[t._v(" "+t._s("audit"==t.dialogForm.type?"审核":"start"==t.dialogForm.type?"开启":"stop"==t.dialogForm.type?"停止":"exec"==t.dialogForm.type?"执行":"del"==t.dialogForm.type?"删除":"kill"==t.dialogForm.type?"强杀":"")+" ")]),e("el-form-item",{staticStyle:{"margin-bottom":"5px"},attrs:{label:"任务ID"}},[t._v(" "+t._s(t.dialogForm.id)+" ")]),e("el-form-item",{staticStyle:{"margin-bottom":"5px"},attrs:{label:"任务名称"}},[t._v(" "+t._s(t.dialogForm.name)+" ")]),e("el-form-item",{staticStyle:{"margin-bottom":"5px"},attrs:{label:"执行目录"}},[t._v(" "+t._s(t.dialogForm.dir)+" ")]),e("el-form-item",{attrs:{label:"执行命令"}},[t._v(" "+t._s(t.dialogForm.command)+" ")])],1)],1),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.dialogVisible=!1}}},[t._v("取 消")]),e("el-button",{attrs:{type:"primary",loading:t.dialogLoading},on:{click:t.dialogSubmit}},[t._v("确 定")])],1)]),e("CrontabDrawer",{attrs:{visible:t.logVisible,detailId:t.logDetailId},on:{"update:visible":function(e){t.logVisible=e}}})],1)},i=[],o=(a("14d9"),function(){var t=this,e=t._self._c;return e("div",[e("el-drawer",{attrs:{title:"任务日志",visible:t.visible,direction:"rtl",size:"1200px","before-close":t.handleClose}},[e("div",[e("el-form",{attrs:{inline:!0}},[e("el-form-item",{attrs:{label:"日期"}},[e("el-date-picker",{attrs:{type:"daterange","range-separator":"至","picker-options":t.pickerOptions,"value-format":"yyyy-MM-dd","start-placeholder":"开始日期","end-placeholder":"结束日期"},model:{value:t.searchForm.date,callback:function(e){t.$set(t.searchForm,"date",e)},expression:"searchForm.date"}})],1),e("el-form-item",{attrs:{label:"状态"}},[e("el-select",{attrs:{placeholder:"请选择状态"},model:{value:t.searchForm.status,callback:function(e){t.$set(t.searchForm,"status",e)},expression:"searchForm.status"}},t._l(t.statuOptions,(function(t){return e("el-option",{key:t.id,attrs:{label:t.name,value:t.id}})})),1)],1),e("el-form-item",[e("el-button",{attrs:{type:"primary"},on:{click:t.handleSearch}},[t._v("查询")]),e("el-button",{attrs:{type:"text"},on:{click:t.clearSearch}},[t._v("清空")])],1)],1),e("div",{staticClass:"page-table-container"},[e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.tableLoading,expression:"tableLoading"}],staticClass:"kw-table-data",attrs:{data:t.tableData,border:"",size:"small","row-key":"id"}},[e("el-table-column",{attrs:{prop:"id",label:"ID",width:"80px"}}),e("el-table-column",{attrs:{prop:"once",label:"执行方式",width:"80px"},scopedSlots:t._u([{key:"default",fn:function({row:e}){return[t._v(" "+t._s(0==e.once?"定时":"手动")+" ")]}}])}),e("el-table-column",{attrs:{prop:"exec_user",label:"执行人"}}),e("el-table-column",{attrs:{prop:"start_time",label:"开始时间",width:"140px"},scopedSlots:t._u([{key:"default",fn:function({row:e}){return[t._v(" "+t._s(t.getComputedDate(e.start_time,!0))+" ")]}}])}),e("el-table-column",{attrs:{prop:"end_time",label:"结束时间",width:"140px"},scopedSlots:t._u([{key:"default",fn:function({row:e}){return[t._v(" "+t._s(t.getComputedDate(e.end_time,!0))+" ")]}}])}),e("el-table-column",{attrs:{prop:"cost_time",label:"耗时"}}),e("el-table-column",{attrs:{prop:"status",label:"状态"},scopedSlots:t._u([{key:"default",fn:function({row:e}){return[t._v(" "+t._s(t.getStatusValue(e.status))+" ")]}}])}),e("el-table-column",{attrs:{prop:"result",label:"结果"}})],1),e("el-pagination",{attrs:{align:"center","current-page":t.currentPage,"page-sizes":[10,20,50,100],"page-size":t.pageSize,layout:"total, sizes, prev, pager, next, jumper",total:t.total},on:{"size-change":t.handleSizeChange,"current-change":t.handleCurrentChange}})],1)],1)])],1)}),r=[],l={props:{visible:Boolean,detailId:Number},data(){return{searchForm:{date:[],status:""},tableData:[],tableLoading:!1,currentPage:1,pageSize:10,total:0,pickerOptions:this.getElementShortcutOptions(),statuOptions:[{id:"Error",name:"失败"},{id:"Success",name:"成功"},{id:"Timeout",name:"超时"}]}},watch:{visible(t){t&&this.init()}},methods:{init(){this.currentPage=1,this.tableData=[],this.clearSearch(),this.getList()},handleClose(){this.$emit("update:visible",!1)},clearSearch(){this.searchForm={date:[],status:""}},handleSearch(){this.currentPage=1,this.getList()},getList(){this.tableLoading=!0,this.$api.node.getCrontabLogList({node_id:+this.$route.query.node_id,page:this.currentPage,page_size:this.pageSize,crontab_id:this.detailId,start_time:this.searchForm.date&&this.searchForm.date.length>0?new Date(this.searchForm.date[0]).getTime()/1e3:void 0,end_time:this.searchForm.date&&this.searchForm.date.length>0?new Date(this.searchForm.date[1]).getTime()/1e3+86399:void 0,status:this.searchForm.status||void 0}).then(t=>{0==t.code?(this.tableData=t.data.list||[],this.total=t.data.total):this.$message.error(t.msg)}).finally(()=>{this.tableLoading=!1})},handleSizeChange(t){this.pageSize=t,this.getList()},handleCurrentChange(t){this.currentPage=t,this.getList()},getStatusValue(t){const e=this.statuOptions.find(e=>e.id==t);return e?e.name:t}}},n=l,d=(a("5fae"),a("2877")),c=Object(d["a"])(n,o,r,!1,null,"11eeedf2",null),u=c.exports,m={name:"crontab",components:{CrontabDrawer:u},data(){return{searchForm:{keyword:""},tableData:[],tableLoading:!1,currentPage:1,pageSize:10,total:0,selectedList:[],dialogVisible:!1,dialogForm:{type:"start",id:0,name:"",dir:"",command:""},dialogLoading:!1,logVisible:!1,logDetailId:""}},mounted(){this.getList()},activated(){this.getList()},methods:{handleReset(){this.searchForm={name:""}},handleSearch(){this.currentPage=1,this.getList()},getList(){this.tableLoading=!0,this.$api.node.getCrontabList({node_id:+this.$route.query.node_id,keyword:this.searchForm.keyword,page:this.currentPage,page_size:this.pageSize}).then(t=>{0==t.code?(this.tableData=t.data.list||[],this.total=t.data.total):this.$message.error(t.msg)}).finally(()=>{this.tableLoading=!1})},handleSizeChange(t){this.pageSize=t,this.getList()},handleCurrentChange(t){this.currentPage=t,this.getList()},handleChangeCommand(t,e){"edit"==t?this.$router.push({path:"/node/crontabEdit",query:{node_id:this.$route.query.node_id,id:e.id}}):(this.dialogVisible=!0,this.dialogForm={...e,type:t})},dialogSubmit(){this.dialogLoading=!0,this.$api.node[this.dialogForm.type+"Crontab"]({node_id:+this.$route.query.node_id,crontab_ids:[this.dialogForm.id]}).then(t=>{0===t.code?(this.$message.success(t.msg),this.dialogVisible=!1,this.getList()):this.$message.error(t.msg)}).finally(()=>{this.dialogLoading=!1})},addCrontab(){this.$router.push({path:"/node/crontabEdit",query:{node_id:this.$route.query.node_id}})},handleBatchDel(){this.$confirm("是否删除选中的定时任务?",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.$api.node.delCrontab({node_id:+this.$route.query.node_id,crontab_ids:this.selectedList.map(t=>t.id)}).then(t=>{0===t.code?(this.$message.success(t.msg),this.getList()):this.$message.error(t.msg)})}).catch(()=>{this.$message({type:"info",message:"已取消删除"})})},handleBatchStop(){this.$api.node.stopCrontab({node_id:+this.$route.query.node_id,crontab_ids:this.selectedList.map(t=>t.id)}).then(t=>{0===t.code?(this.$message.success(t.msg),this.getList()):this.$message.error(t.msg)})},handleBatchStart(){this.$api.node.startCrontab({node_id:+this.$route.query.node_id,crontab_ids:this.selectedList.map(t=>t.id)}).then(t=>{0===t.code?(this.$message.success(t.msg),this.getList()):this.$message.error(t.msg)})},handleBatchAudit(){this.$api.node.auditCrontab({node_id:+this.$route.query.node_id,crontab_ids:this.selectedList.map(t=>t.id)}).then(t=>{0===t.code?(this.$message.success(t.msg),this.getList()):this.$message.error(t.msg)})},toConfig(){this.$router.push({path:"/node/config"})},toLog(){this.$router.push({path:"/node/nodeLog"})},showCrontabLog(t){this.logVisible=!0,this.logDetailId=t.id},goto(t,e){this.$router.push({path:t,query:e})}}},h=m,p=Object(d["a"])(h,s,i,!1,null,null,null);e["default"]=p.exports},"5fae":function(t,e,a){"use strict";a("ef52")},ef52:function(t,e,a){}}]);